node('jupiter-16G-1'){            // Running on x86 runner containing latest vector qemu, latest vector gcc and all the necessary libraries
    stage('Cleanup'){
        cleanWs()               // Cleaning previous CI build in workspace
    }
    stage('Install dependencies'){
        sh'''
            #!/bin/bash

            set -x

            sudo apt update
            sudo apt install -y cmake build-essential git curl libcurl4-openssl-dev
        '''
    }
    stage('checkout repo'){
        retry(5){               // Retry if the cloning fails due to some reason
            checkout scm        // Clone the repo on Runner
        }
    }
    stage('Compiling llama.cpp'){
        sh'''#!/bin/bash
            
            set -x

            alias gcc='/usr/bin/gcc-14' # Workaround for RVV error
            alias g++='/usr/bin/g++-14' # Workaround for RVV error

            gcc --version
            g++ --version
            
            cmake -B build
            cmake --build build --config Release -j8 --target llama-cli llama-quantize
        '''
    }
    stage('Running llama.cpp'){
        sh'''#!/bin/bash
            
            set -x

           ./build/bin/llama-cli -m {GGUF_WEIGHT} -p "Hi, how are you?" -n 10
        '''
    }
}
